<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Virtual Anaglyph Glasses</title>
  <style>
    body {
      margin: 0;
      overflow: hidden; /* Prevent scrolling on small screens */
      display: flex;
      flex-direction: column;
      align-items: center;
      height: 100vh; /* Full viewport height */
      background-color: black; /* Set the background color to black */
      color: white; /* Set text color to white */
    }

    #webcam {
      display: none; /* Hide the webcam element initially */
    }

    #info {
      display: flex;
      flex-direction: row;
      align-items: center;
      justify-content: center;
      margin-bottom: 20px;
    }

    h1 {
      font-size: 24px;
      margin: 0 10px; /* Add some margin between the elements */
    }

    #flipButton,
    #zoomSlider {
      background-color: white;
      color: black;
      padding: 5px;
      cursor: pointer;
      border: none;
      border-radius: 5px;
      margin: 0 10px; /* Add some margin between the elements */
    }

    #githubLink {
      font-size: 12px;
      text-decoration: none;
      color: #61dafb; /* Set link color to blue */
      margin: 0 10px; /* Add some margin between the elements */
    }

    #glasses {
      display: flex;
    }

    .redglass,
    .greenglass {
      box-sizing: border-box;
      width: 50vw; /* Make each canvas fill half the screen width */
      height: auto; /* Maintain aspect ratio */
      object-fit: cover; /* Maintain aspect ratio without stretching */
      background-color: black; /* Set the background color to black */
      border: none; /* Remove the border */
      margin: 10px;
    }
  </style>
</head>
<body>
  <video id="webcam" width="640" height="480" autoplay></video>

  <div id="info">
    <h1>Virtual Anaglyph Glasses</h1>
    <button id="flipButton" onclick="flipCamera()">Flip Camera</button>
    <input type="range" id="zoomSlider" min="1" max="3" step="0.1" value="1" oninput="updateZoom()">
    <a id="githubLink" href="https://github.com/mofosyne/AnaglyphGlasses" target="_blank">Github Project Page</a>
  </div>

  <div id="glasses">
    <canvas id="redCanvas" class="redglass" width="320" height="240"></canvas>
    <canvas id="greenCanvas" class="greenglass" width="320" height="240"></canvas>
  </div>

  <script>
    let currentCamera = 'environment'; // 'user' for front camera, 'environment' for back camera
    const webcam = document.getElementById('webcam');
    const redCanvas = document.getElementById('redCanvas');
    const greenCanvas = document.getElementById('greenCanvas');
    const zoomSlider = document.getElementById('zoomSlider');

    async function getCameraStream() {
      try {
        const constraints = {
          video: {
            facingMode: currentCamera
          }
        };

        const stream = await navigator.mediaDevices.getUserMedia(constraints);
        webcam.srcObject = stream;
      } catch (error) {
        console.error('Error accessing webcam:', error);
      }
    }

    function flipCamera() {
      currentCamera = currentCamera === 'user' ? 'environment' : 'user';
      getCameraStream();
    }

    function updateZoom() {
      const zoomValue = zoomSlider.value;

      const redContext = redCanvas.getContext('2d');
      const greenContext = greenCanvas.getContext('2d');

      // Clear previous transformations
      redContext.setTransform(1, 0, 0, 1, 0, 0);
      greenContext.setTransform(1, 0, 0, 1, 0, 0);

      // Get the center coordinates
      const centerX = redCanvas.width / 2;
      const centerY = redCanvas.height / 2;

      // Translate to the center
      redContext.translate(centerX, centerY);
      greenContext.translate(centerX, centerY);

      // Apply zoom to red canvas
      redContext.scale(zoomValue, zoomValue);

      // Apply zoom to green canvas
      greenContext.scale(zoomValue, zoomValue);

      // Translate back to the original position
      redContext.translate(-centerX, -centerY);
      greenContext.translate(-centerX, -centerY);
    }

    // Check for webcam support and select the back-facing camera if available, otherwise, fallback to any camera
    getCameraStream();

    function processFrame() {
      const redContext = redCanvas.getContext('2d');
      const greenContext = greenCanvas.getContext('2d');

      // Draw webcam video on both canvases
      redContext.drawImage(webcam, 0, 0, redCanvas.width, redCanvas.height);
      greenContext.drawImage(webcam, 0, 0, greenCanvas.width, greenCanvas.height);

      // Extract red channel for the red canvas
      const redImageData = redContext.getImageData(0, 0, redCanvas.width, redCanvas.height);
      for ( let i = 0; i < redImageData.data.length; i += 4) {
        // Set green and blue channels to zero
        redImageData.data[i + 1] = 0;
        redImageData.data[i + 2] = 0;
      }
      redContext.putImageData(redImageData, 0, 0);

      // Extract green channel for the green canvas
      const greenImageData = greenContext.getImageData(0, 0, greenCanvas.width, greenCanvas.height);
      for ( let i = 0; i < greenImageData.data.length; i += 4) {
        // Set red and blue channels to zero
        greenImageData.data[i] = 0;
        greenImageData.data[i + 2] = 0;
      }
      greenContext.putImageData(greenImageData, 0, 0);

      // Repeat the process for each frame
      requestAnimationFrame(processFrame);
    }

    // Start processing frames once the webcam is ready
    webcam.addEventListener('loadeddata', () => {
      requestAnimationFrame(processFrame);
    });
  </script>
</body>
</html>
